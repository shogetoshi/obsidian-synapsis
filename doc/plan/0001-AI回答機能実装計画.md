# Issue 0001: AI回答機能実装計画

## Issue概要
- テキストフィールドに書かれた文章をAIに渡してその回答を保存する
- OpenAIのGPT-4o (gpt-4o) を使用する

## 現状のアーキテクチャ分析

### 既存の構成
- **フレームワーク**: FastAPI
- **主要ファイル**: `main.py` (単一ファイル構成)
- **機能**: テキストを受け取り、タイムスタンプ付きでMarkdownファイルとして保存
- **保存先**: `data/` ディレクトリ
- **UI**: HTMLをインラインで提供 (SPA風の構成)

### 既存のエンドポイント
1. `GET /` - Webページ表示
2. `POST /save` - テキスト保存
3. `GET /health` - ヘルスチェック

### 既存のデータモデル
- `SaveRequest`: filename (任意), content (必須)
- `SaveResponse`: success, filepath, message

## 実装計画

### 1. 環境設定・依存関係の追加

#### 1.1 OpenAI SDKの追加
**ファイル**: `pyproject.toml`
```toml
dependencies = [
    "fastapi>=0.115.0",
    "uvicorn[standard]>=0.32.0",
    "openai>=1.0.0",  # 追加
    "python-dotenv>=1.0.0",  # 環境変数管理用（既に依存関係にある）
]
```

#### 1.2 環境変数ファイルの作成
**ファイル**: `.env` (新規作成)
```
OPENAI_API_KEY=your-api-key-here
```

**ファイル**: `.env.example` (新規作成)
```
OPENAI_API_KEY=
```

#### 1.3 .gitignoreの更新
**ファイル**: `.gitignore`
```
.env  # APIキーを含む環境変数ファイルを除外
```

### 2. コード実装

#### 2.1 新しいデータモデルの追加
**ファイル**: `main.py`

追加するモデル:
```python
class AskAIRequest(BaseModel):
    """AI問い合わせリクエストのスキーマ"""
    content: str  # ユーザーの質問
    filename: str | None = None  # 保存するファイル名（任意）

class AskAIResponse(BaseModel):
    """AI問い合わせレスポンスのスキーマ"""
    success: bool
    ai_response: str  # AIの回答
    filepath: str  # 保存したファイルのパス
    message: str
```

#### 2.2 OpenAI設定・初期化コードの追加
**ファイル**: `main.py` (冒頭部分)

```python
import os
from dotenv import load_dotenv
from openai import OpenAI

# 環境変数の読み込み
load_dotenv()

# OpenAIクライアントの初期化
openai_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
```

#### 2.3 AI問い合わせ機能の実装
**ファイル**: `main.py`

新しいエンドポイント:
```python
@app.post("/ask-ai", response_model=AskAIResponse)
async def ask_ai(request: AskAIRequest) -> AskAIResponse:
    """
    ユーザーの質問をAIに送信し、回答をファイルとして保存

    - content: ユーザーの質問
    - filename: ファイル名（省略時は日時ベースで自動生成）
    """
    try:
        # OpenAI APIを呼び出し
        response = openai_client.chat.completions.create(
            model="gpt-4o",  # GPT-4o使用
            messages=[
                {"role": "user", "content": request.content}
            ],
            temperature=0.7,
        )

        ai_response = response.choices[0].message.content

        # ファイル名の決定
        if request.filename:
            filename = request.filename
        else:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"ai_{timestamp}.md"

        # パストラバーサル対策
        safe_filename = Path(filename).name
        if not safe_filename:
            raise HTTPException(status_code=400, detail="無効なファイル名です")

        filepath = DATA_DIR / safe_filename

        # 質問と回答をMarkdown形式で保存
        content_to_save = f"# 質問\n\n{request.content}\n\n# AI回答\n\n{ai_response}\n"
        filepath.write_text(content_to_save, encoding="utf-8")

        return AskAIResponse(
            success=True,
            ai_response=ai_response,
            filepath=str(filepath),
            message=f"AI回答を保存しました: {safe_filename}",
        )

    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"AI処理中にエラーが発生しました: {str(e)}"
        ) from e
```

#### 2.4 UIの更新
**ファイル**: `main.py` (index関数のHTML部分)

追加する要素:
1. 「AIに質問」ボタンの追加
2. AI回答表示エリアの追加
3. JavaScriptでの`/ask-ai`エンドポイント呼び出し

HTML/CSS/JavaScript追加箇所:
```html
<!-- ボタンを2つに分ける -->
<button id="saveBtn" onclick="saveContent()">保存</button>
<button id="askAIBtn" onclick="askAI()" style="background: #10b981;">AIに質問</button>

<!-- AI回答表示エリア -->
<div id="aiResponse" style="margin-top: 20px; padding: 16px; background: #2d2d2d; border-radius: 8px; display: none;">
    <h3 style="color: #10b981; margin-top: 0;">AI回答</h3>
    <div id="aiResponseContent" style="white-space: pre-wrap;"></div>
</div>

<!-- JavaScript関数の追加 -->
<script>
async function askAI() {
    const content = document.getElementById('content').value;
    const btn = document.getElementById('askAIBtn');
    const msg = document.getElementById('message');
    const responseDiv = document.getElementById('aiResponse');
    const responseContent = document.getElementById('aiResponseContent');

    if (!content.trim()) {
        msg.textContent = '質問を入力してください';
        msg.className = 'error';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'AI処理中...';
    responseDiv.style.display = 'none';

    try {
        const res = await fetch('/ask-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        const data = await res.json();

        if (res.ok) {
            msg.textContent = data.message;
            msg.className = 'success';
            responseContent.textContent = data.ai_response;
            responseDiv.style.display = 'block';
        } else {
            msg.textContent = data.detail || 'AI処理に失敗しました';
            msg.className = 'error';
        }
    } catch (e) {
        msg.textContent = 'エラー: ' + e.message;
        msg.className = 'error';
    } finally {
        btn.disabled = false;
        btn.textContent = 'AIに質問';
    }
}
</script>
```

### 3. セキュリティ・エラーハンドリング

#### 3.1 環境変数のバリデーション
**ファイル**: `main.py` (startup_event関数に追加)

```python
@app.on_event("startup")
async def startup_event() -> None:
    """起動時にdataディレクトリを作成し、環境変数を確認"""
    DATA_DIR.mkdir(exist_ok=True)

    # OpenAI APIキーの存在確認
    if not os.getenv("OPENAI_API_KEY"):
        raise RuntimeError("OPENAI_API_KEY環境変数が設定されていません")
```

#### 3.2 レート制限・タイムアウト対策
- OpenAI APIのタイムアウト設定を追加
- 必要に応じてリトライ機能を実装

#### 3.3 エラーメッセージの適切な処理
- APIキーエラー
- レート制限エラー
- ネットワークエラー

### 4. テスト計画

#### 4.1 手動テスト項目
1. 正常系:
   - テキスト入力してAI質問ボタンを押下
   - AI回答が表示される
   - ファイルがdata/ディレクトリに保存される
   - ファイル内容に質問と回答が含まれる

2. 異常系:
   - 空の質問を送信
   - APIキーが未設定の状態での起動
   - ネットワークエラー時の挙動

#### 4.2 自動テスト (今後の課題)
- pytest-asyncを使用したエンドポイントテスト
- OpenAI APIのモック化

### 5. 実装順序

1. **依存関係の追加とインストール**
   - pyproject.tomlの更新
   - `uv sync` または `pip install -e .`の実行

2. **環境変数の設定**
   - `.env`ファイルの作成
   - `.gitignore`の更新
   - `.env.example`の作成

3. **バックエンドの実装**
   - データモデルの追加
   - OpenAIクライアントの初期化
   - `/ask-ai`エンドポイントの実装
   - エラーハンドリングの実装

4. **フロントエンドの実装**
   - HTMLの更新（ボタン、表示エリア追加）
   - JavaScriptの更新（API呼び出し関数追加）
   - CSSの調整

5. **テストと動作確認**
   - サーバー起動確認
   - 機能テスト
   - エラーケースの確認

### 6. 考慮事項

#### 6.1 GPT-5.2について
- **注意**: 2026年1月時点で、OpenAIの公開モデルに「GPT-5.2」は存在しません
- 利用可能な最新モデル:
  - `gpt-4o` (GPT-4 Optimized)
  - `gpt-4-turbo`
  - `gpt-3.5-turbo`
- **推奨**: `gpt-4o`を使用（最新かつ高性能）
- もし将来的にGPT-5.2がリリースされた場合は、model名を変更するだけで対応可能

#### 6.2 コスト管理
- OpenAI APIは従量課金制
- 開発時はmax_tokensを設定してコストを制限することを推奨
- 本番環境ではモニタリングを実装

#### 6.3 拡張性
- 現在のシンプルな構成を維持
- 将来的な拡張:
  - 会話履歴の保持
  - 異なるAIモデルの選択機能
  - ストリーミングレスポンス

## まとめ

本実装計画では、既存のシンプルな構成を保ちながら、OpenAI APIを統合してAI問い合わせ機能を追加します。主な変更点は:

- OpenAI SDKの依存関係追加
- 新しい`/ask-ai`エンドポイントの実装
- UI上での「AIに質問」機能の追加
- 質問と回答のセットをMarkdownファイルとして保存

実装後は、ユーザーがテキストフィールドに質問を入力し、「AIに質問」ボタンをクリックすることで、AIの回答を得て、それを自動的にファイルとして保存できるようになります。
